# 🏆 设计理念

本文档说明 DataAcquisition 系统的核心设计理念和架构原则。

## 相关文档

- [核心模块文档](modules.md) - 了解系统核心模块
- [数据处理流程](data-flow.md) - 理解数据流转过程

## WAL-first 架构

系统核心设计理念是"数据安全第一"。所有数据采集后立即写入本地 Parquet 文件作为预写日志，然后再异步写入 InfluxDB。这种设计确保即使在网络故障、存储服务不可用等异常情况下，数据也不会丢失。

### 核心原则

- **数据优先**: 数据安全是最高优先级
- **本地持久化**: 所有数据必须先写入本地
- **异步写入**: 主存储写入采用异步方式，不阻塞采集
- **自动恢复**: 系统自动重试失败的写入操作

### 实现方式

1. **双写策略**: 数据同时写入 Parquet WAL 和 InfluxDB
2. **原子操作**: 只有两者都成功才删除 WAL 文件
3. **重试机制**: 写入失败时保留 WAL 文件，定期重试
4. **零丢失保证**: 确保数据在任何情况下都不会丢失

## 模块化设计

系统采用清晰的分层架构，各模块通过接口抽象，支持灵活扩展和替换。新的 PLC 协议、存储后端、数据处理逻辑都可以通过实现相应接口快速集成。

### 分层架构

```
┌─────────────────────────────────────┐
│     Application Layer               │  ← 接口定义
├─────────────────────────────────────┤
│     Domain Layer                    │  ← 领域模型
├─────────────────────────────────────┤
│     Infrastructure Layer            │  ← 具体实现
└─────────────────────────────────────┘
```

### 接口抽象

- **IPLCClientService**: PLC 客户端服务接口
- **IDataStorageService**: 数据存储服务接口
- **IChannelCollector**: 通道采集器接口
- **IQueueService**: 队列服务接口
- **IMetricsCollector**: 指标收集器接口

### 扩展性

- **插件化**: 新功能可以通过实现接口快速集成
- **可替换**: 核心组件可以替换为其他实现
- **松耦合**: 模块之间通过接口交互，降低耦合度

## 运维友好

内置完整的监控指标和可视化界面，支持配置热更新，提供详细的日志记录，大大降低了运维复杂度。

### 监控能力

- **Prometheus 指标**: 完整的系统指标暴露
- **可视化界面**: Vue3 前端界面，直观展示系统状态
- **日志系统**: SQLite 日志数据库，支持查询和分析
- **健康检查**: 内置健康检查端点

### 可维护性

- **配置热更新**: 无需重启即可应用新配置
- **详细日志**: 记录关键操作和错误信息
- **错误追踪**: 完整的错误堆栈和上下文信息
- **文档完善**: 详细的配置和使用文档

### 部署便捷

- **容器化支持**: 支持 Docker 部署
- **环境变量**: 支持通过环境变量配置
- **多平台**: 支持 Windows、Linux、macOS
- **依赖明确**: 清晰的依赖关系和要求

## Edge-Central 分布式架构

系统采用 Edge-Central 分布式架构，支持多车间、多节点的集中式管理。

### 架构优势

- **分布式部署**: Edge Agent 可以分布式部署在各个车间
- **集中管理**: Central API 统一管理和监控所有节点
- **高可用性**: 单个节点故障不影响其他节点
- **可扩展性**: 易于添加新的 Edge Agent 节点

### 数据流转

1. **本地采集**: Edge Agent 在本地采集 PLC 数据
2. **本地存储**: 数据先存储在本地（Parquet WAL）
3. **远程上报**: 可选地上报数据到 Central API
4. **集中监控**: Central Web 统一监控所有节点

> 关于性能优化的详细建议和最佳实践，请参考 [性能优化文档](performance.md)

## 安全性

系统在安全性方面采用以下措施：

- **InfluxDB Token 认证**: 系统通过 Token 与 InfluxDB 进行身份验证，Token 配置在 `appsettings.json` 中，建议使用环境变量管理敏感信息
- **CORS 配置**: 支持配置允许的前端来源，防止跨域攻击
- **环境变量配置**: 支持通过环境变量管理敏感配置信息（如 Token），避免在配置文件中明文存储

**安全建议**：
- 生产环境建议使用环境变量管理 InfluxDB Token 等敏感信息
- 建议在网络层面配置防火墙规则，限制 API 访问
- 建议在生产环境使用反向代理（如 Nginx）配置 HTTPS

## 下一步

了解设计理念后，你可以：

- 阅读 [核心模块文档](modules.md) 深入了解系统核心模块
- 阅读 [常见问题](faq.md) 获取更多帮助
- 阅读 [数据处理流程](data-flow.md) 理解数据流转过程
